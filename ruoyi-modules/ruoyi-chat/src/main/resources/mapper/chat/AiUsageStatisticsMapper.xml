<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.ruoyi.chat.mapper.AiUsageStatisticsMapper">

    <resultMap id="AiUsageStatisticsResult" type="org.ruoyi.chat.domain.entity.AiUsageStatistics">
        <id     property="id"             column="id"             />
        <result property="statDate"       column="stat_date"      />
        <result property="statType"       column="stat_type"      />
        <result property="userId"         column="user_id"        />
        <result property="modelName"      column="model_name"     />
        <result property="conversationCount" column="conversation_count" />
        <result property="messageCount"   column="message_count"  />
        <result property="promptTokens"   column="prompt_tokens"  />
        <result property="completionTokens" column="completion_tokens" />
        <result property="totalTokens"    column="total_tokens"   />
        <result property="totalCost"      column="total_cost"     />
        <result property="createTime"     column="create_time"    />
        <result property="updateTime"     column="update_time"    />
    </resultMap>

    <sql id="selectAiUsageStatisticsVo">
        select id, stat_date, stat_type, user_id, model_name, conversation_count, message_count,
               prompt_tokens, completion_tokens, total_tokens, total_cost, create_time, update_time from ai_usage_statistics
    </sql>

    <sql id="queryConditions">
        <where>
            <if test="query.statType != null and query.statType != ''">
                AND stat_type = #{query.statType}
            </if>
            <if test="query.userId != null">
                AND user_id = #{query.userId}
            </if>
            <if test="query.modelName != null and query.modelName != ''">
                AND model_name = #{query.modelName}
            </if>
            <if test="query.startTime != null">
                AND stat_date >= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND stat_date <= #{query.endTime}
            </if>
        </where>
    </sql>

    <select id="selectStatisticsPage" resultMap="AiUsageStatisticsResult">
        <include refid="selectAiUsageStatisticsVo"/>
        <include refid="queryConditions"/>
        order by stat_date desc, id desc
    </select>

    <select id="selectStatisticsList" resultMap="AiUsageStatisticsResult">
        <include refid="selectAiUsageStatisticsVo"/>
        <include refid="queryConditions"/>
        order by stat_date desc, id desc
    </select>

    <!-- 按用户统计使用情况 -->
    <select id="selectUserUsageStatistics" resultType="map">
        SELECT 
            c.user_id as userId,
            u.nick_name as userName,
            COUNT(DISTINCT c.session_id) as chatCount,
            COUNT(c.id) as messageCount,
            SUM(c.prompt_tokens) as promptTokens,
            SUM(c.completion_tokens) as completionTokens,
            SUM(c.total_tokens) as totalTokens,
            SUM(c.deduct_cost) as totalCost
        FROM chat_message c
        left join sys_user u on c.user_id = u.user_id
        <where>
            create_time >= #{query.startTime}
            AND create_time <![CDATA[ < ]]> DATE_ADD(#{query.endTime}, INTERVAL 1 DAY)
            <if test="query.userId != null">
                AND c.user_id = #{query.userId}
            </if>
        </where>
        GROUP BY c.user_id, u.nick_name
        ORDER BY totalTokens desc
    </select>

    <!-- 按模型统计使用情况 -->
    <select id="selectModelUsageStatistics" resultType="map">
        SELECT 
            c.model as modelName,
            COUNT(DISTINCT c.session_id) as chatCount,
            COUNT(c.id) as messageCount,
            SUM(c.prompt_tokens) as promptTokens,
            SUM(c.completion_tokens) as completionTokens,
            SUM(c.total_tokens) as totalTokens,
            SUM(c.deduct_cost) as totalCost
        FROM chat_message c
        <where>
            c.model is not null
            AND create_time >= #{query.startTime}
            AND create_time <![CDATA[ < ]]> DATE_ADD(#{query.endTime}, INTERVAL 1 DAY)
            <if test="query.modelName != null and query.modelName != ''">
                AND c.model like concat('%', #{query.modelName}, '%')
            </if>
        </where>
        GROUP BY c.model
        ORDER BY totalTokens desc
    </select>

    <!-- 统计用户对话次数 -->
    <select id="countUserConversations" resultType="map">
        SELECT 
            DATE(create_time) as stat_date,
            COUNT(DISTINCT session_id) as conversation_count
        FROM chat_message
        <where>
            <if test="query.userId != null">
                AND user_id = #{query.userId}
            </if>
            <if test="query.startTime != null">
                AND create_time >= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND create_time <![CDATA[ < ]]> DATE_ADD(#{query.endTime}, INTERVAL 1 DAY)
            </if>
        </where>
        GROUP BY DATE(create_time)
        ORDER BY stat_date
    </select>

    <!-- 统计模型使用趋势 -->
    <select id="selectModelUsageTrend" resultType="map">
        SELECT 
            DATE(create_time) as statDate,
            c.model as modelName,
            COUNT(DISTINCT c.session_id) as chatCount,
            SUM(c.prompt_tokens) as promptTokens,
            SUM(c.completion_tokens) as completionTokens,
            SUM(c.total_tokens) as totalTokens,
            SUM(c.deduct_cost) as totalCost
        FROM chat_message c
        <where>
            c.model is not null
            <if test="query.modelName != null and query.modelName != ''">
                AND c.model like concat('%', #{query.modelName}, '%')
            </if>
            <if test="query.startTime != null">
                AND create_time >= #{query.startTime}
            </if>
            <if test="query.endTime != null">
                AND create_time <![CDATA[ < ]]> DATE_ADD(#{query.endTime}, INTERVAL 1 DAY)
            </if>
        </where>
        GROUP BY DATE(create_time), c.model
        ORDER BY statDate desc, modelName
    </select>

    <!-- 从chat_message表同步每日统计数据 -->
    <insert id="statDailyData">
        insert into ai_usage_statistics
        (stat_date, stat_type, user_id, model_name, conversation_count, message_count,
         prompt_tokens, completion_tokens, total_tokens, total_cost)
        select
            date(c.create_time) as stat_date,
            '1' as stat_type,
            c.user_id,
            c.model,
            count(distinct c.session_id) as conversation_count,
            count(c.id) as message_count,
            sum(c.prompt_tokens) as prompt_tokens,
            sum(c.completion_tokens) as completion_tokens,
            sum(c.total_tokens) as total_tokens,
            sum(c.deduct_cost) as total_cost
        from chat_message c
        where date(c.create_time) = #{statDate}
        group by date(c.create_time), c.user_id, c.model
        on duplicate key update
            conversation_count = values(conversation_count),
            message_count = values(message_count),
            prompt_tokens = values(prompt_tokens),
            completion_tokens = values(completion_tokens),
            total_tokens = values(total_tokens),
            total_cost = values(total_cost),
            update_time = current_timestamp
    </insert>

</mapper>